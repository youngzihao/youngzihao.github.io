<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ARKit by Tutorials Section Ⅱ 野生笔记 · Feng Shui</title><meta name="description" content="ARKit by Tutorials Section Ⅱ 野生笔记 - null"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Feng Shui"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.svg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/youngzihao" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">ARKit by Tutorials Section Ⅱ 野生笔记</h1><div class="post-info">Sep 23, 2018</div><div class="post-content"><h1 id="Chapter-7-Get-Started-Portal-App"><a href="#Chapter-7-Get-Started-Portal-App" class="headerlink" title="Chapter 7: Get Started: Portal App"></a>Chapter 7: Get Started: Portal App</h1><h2 id="Get-started"><a href="#Get-started" class="headerlink" title="Get started"></a>Get started</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 1</span><br><span class="line">@IBOutlet var sceneView: ARSCNView?</span><br><span class="line">// 2</span><br><span class="line">@IBOutlet weak var messageLabel: UILabel?</span><br><span class="line">// 3</span><br><span class="line">@IBOutlet weak var sessionStateLabel: UILabel?</span><br></pre></td></tr></table></figure>
<ol>
<li>sceneView 被用来给摄像头视图增加 3D 物体</li>
<li>显示指示信息</li>
<li>显示会话状态</li>
</ol>
<ul>
<li><p>ARKit 处理所有的传感器和摄像头数据，但是不会生成任何虚拟内容，你需要依靠其他框架来在场景中增加虚拟内容，例如 SceneKit 或 SpriteKit</p>
</li>
<li><p>ARSCNView 是一种苹果提供的框架，能够轻松整合 ARKit 数据和 SceneKit</p>
</li>
</ul>
<h2 id="Setting-up-ARKit"><a href="#Setting-up-ARKit" class="headerlink" title="Setting up ARKit"></a>Setting up ARKit</h2><ul>
<li>开始的第一步是使用摄像头去捕捉视频流，你将用到一个 ARSCNView 对象</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">func runSession() &#123;</span><br><span class="line">  // 1  </span><br><span class="line">  let configuration = ARWorldTrackingConfiguration.init()</span><br><span class="line">  // 2</span><br><span class="line">  configuration.planeDetection = .horizontal</span><br><span class="line">  // 3</span><br><span class="line">  configuration.isLightEstimationEnabled = true</span><br><span class="line">  // 4</span><br><span class="line">  sceneView?.session.run(configuration)</span><br><span class="line"></span><br><span class="line">  // 5</span><br><span class="line">  #if DEBUG</span><br><span class="line">    sceneView?.debugOptions = [ARSCNDebugOptions.showFeaturePoints]</span><br><span class="line">  #endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>实例化了一个 ARWorldTrackingConfiguration 对象，并为 ARSession 定义了配置，这有两种类型的配置：ARSessionConfiguration 和 ARWorldTrackingConfiguration</li>
<li>configuration.planeDetection 被设置为侦测水平平面，平面范围大小可以改变，随着摄像机移动多个平面可以合成为一个</li>
<li>启用光线估计计算，被转换框架才采用，使得虚拟内容看上去更加真实</li>
<li>根据配置来开启 AR 的处理进程。将会开启 AR 会话以及来自摄像头的视频流捕捉，最后显示在 sceneView 上</li>
<li>排错设置，增加可视的光点，覆盖在摄像头视图上</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">func resetLabels() &#123;</span><br><span class="line">  messageLabel?.alpha = 1.0</span><br><span class="line">  messageLabel?.text =</span><br><span class="line">    &quot;Move the phone around and allow the app to find a plane.&quot; +</span><br><span class="line">    &quot;You will see a yellow horizontal plane.&quot;</span><br><span class="line">  sessionStateLabel?.alpha = 0.0</span><br><span class="line">  sessionStateLabel?.text = &quot;&quot;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置标签的默认值，调整 messageLabel 和 sessionStateLabel 的不透明度和内容，messageLabel 被用力显示指明给用户，然而 sessionStateLabel 被用来显示错误信息，这种情况下属于出错</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">override func viewDidLoad() &#123;</span><br><span class="line">  super.viewDidLoad()    </span><br><span class="line">  resetLabels()</span><br><span class="line">  runSession()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当 app 启动并加载视图的时候开启 ARKit session </li>
</ul>
<h2 id="Plane-detection-and-rendering"><a href="#Plane-detection-and-rendering" class="headerlink" title="Plane detection and rendering"></a>Plane detection and rendering</h2><ul>
<li>扩展  PortalViewController 以至于它能够执行 ARSCNViewDelegate 协议</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">extension PortalViewController: ARSCNViewDelegate &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置 sceneView 的 delegate 为 PortalViewController</li>
</ul>
<blockquote>
<p>runSession()</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sceneView?.delegate = self</span><br></pre></td></tr></table></figure>
<ul>
<li>ARPlaneAnchors 被自动添加给了 ARSession 锚数组，ARSCNView 自动将 ARPlaneAnchor 对象转换成为 SCNNode nodes，为了去提供这些平面，你需要去执行 delegate 方法在 ARSCNViewDelegate 扩展中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 1</span><br><span class="line">func renderer(_ renderer: SCNSceneRenderer,</span><br><span class="line">              didAdd node: SCNNode,</span><br><span class="line">              for anchor: ARAnchor) &#123;</span><br><span class="line">  // 2</span><br><span class="line">  DispatchQueue.main.async &#123;</span><br><span class="line">    // 3</span><br><span class="line">    if let planeAnchor = anchor as? ARPlaneAnchor &#123;</span><br><span class="line">        // 4</span><br><span class="line">      #if DEBUG</span><br><span class="line">        // 5</span><br><span class="line">        let debugPlaneNode = createPlaneNode(</span><br><span class="line">          center: planeAnchor.center,</span><br><span class="line">          extent: planeAnchor.extent)</span><br><span class="line">        // 6  </span><br><span class="line">        node.addChildNode(debugPlaneNode)</span><br><span class="line">      #endif</span><br><span class="line">      // 7</span><br><span class="line">      self.messageLabel?.text =</span><br><span class="line">      &quot;Tap on the detected horizontal plane to place the portal&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>当ARSession 侦测到了一个新的平面时，renderer(_:didAdd:for:) 被调用，ARSCNView 会自动为这个平面增加一个 ARPlaneAnchor</li>
<li>这个调用发生在后台线程，但在这里，你将代码块发送到主线程，因为任何更新 UI 的操作都应该在主线程中完成</li>
<li>检查了 ARAnchor 是否被了一个 ARPlaneAnchor</li>
<li>检查你是否在排错模式</li>
<li>如果是这样，通过传入 planeAnchor 的中心和范围大小来创建 plane SCNNode</li>
<li>node 现在是一个空的 SCNNode，通过 ARSCNView 被自动添加到场景中，它的坐标与 ARAnchor 的位置一样，现在你需要添加 debugPlaneNode 作为一个子结点，以至于它能够放置于跟 node 一样的位置上 </li>
<li>最后，无论你是不是在排错模式，你都更新指示消息给玩家，表示准备完毕可以将门放入场景中</li>
</ol>
<ul>
<li>创建一个新的Swift file 名为 SCNNodeHelpers.swift，这个文件将会包含所有与生成 SCNNode objects 相关的代码</li>
</ul>
<blockquote>
<p>SCNNodeHelpers.swift</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import SceneKit</span><br><span class="line"></span><br><span class="line">  // 1</span><br><span class="line">func createPlaneNode(center: vector_float3,</span><br><span class="line">                     extent: vector_float3) -&gt; SCNNode &#123;</span><br><span class="line">  // 2</span><br><span class="line">  let plane = SCNPlane(width: CGFloat(extent.x),</span><br><span class="line">                      height: CGFloat(extent.z))</span><br><span class="line">  // 3</span><br><span class="line">  let planeMaterial = SCNMaterial()</span><br><span class="line">  planeMaterial.diffuse.contents = UIColor.yellow.withAlphaComponent(0.4)</span><br><span class="line">  // 4</span><br><span class="line">  plane.materials = [planeMaterial]</span><br><span class="line">  // 5</span><br><span class="line">  let planeNode = SCNNode(geometry: plane)</span><br><span class="line">  // 6</span><br><span class="line">  planeNode.position = SCNVector3Make(center.x, 0, center.z)</span><br><span class="line">  // 7</span><br><span class="line">  planeNode.transform = SCNMatrix4MakeRotation(-Float.pi / 2, 1, 0, 0)</span><br><span class="line">  // 8</span><br><span class="line">  return planeNode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>createPlaneNode 方法有两个参数， 将提供的平面的中心和范围大小，都是 vector_float3 类型， 表示了点坐标，这个函数返回一个SCNNode object </li>
<li>你实例化了这个 SCNPlane 通过具体说明平面的宽度和广度，你从 extent 的 x 坐标中得到了宽度，从 z 坐标中得到了高度 </li>
<li>你初始化了 SCNMaterial 并为它配置了 diffuse content，diffuse layer color 被设置为半透明的黄色</li>
<li>SCNMaterial 被添加给了平面的 materials 数组，定义了平面的材质和颜色</li>
<li>使用 plane 的几何大小创建了一个 SCNNode，The SCNPlane inherits from the SCNGeometry class, which only provides the form of a visible object rendered by SceneKit. You specify the position and orientation of the geometry by attaching it to an SCNNode object. Multiple nodes can reference the same geometry object, allowing it to appear at different positions in a scene.</li>
<li>设置 planeNode 的位置，注意 node 被翻译为了 coordinates (center.x, 0, center.z) ，通过 ARPlaneAnchor instance</li>
<li>SceneKit 中的平面默认都是垂直的，因此你需要去旋转 90°使之水平</li>
<li>返回一个 planeNode 对象<h1 id="Chapter-8-Add-Objects-to-your-World"><a href="#Chapter-8-Add-Objects-to-your-World" class="headerlink" title="Chapter 8: Add Objects to your World"></a>Chapter 8: Add Objects to your World</h1></li>
</ol>
<h1 id="Chapter-9-Geomtry-Textrues-and-lighting"><a href="#Chapter-9-Geomtry-Textrues-and-lighting" class="headerlink" title="Chapter 9: Geomtry, Textrues, and lighting"></a>Chapter 9: Geomtry, Textrues, and lighting</h1></div></article></div></main><footer><div class="paginator"><a href="/2018/09/18/arkitSection1/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 - 2018 <a href="http://yoursite.com"></a> <a href="https://hexo.io/" target="_blank"> </a> <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank"> </a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>